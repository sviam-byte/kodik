## 1. Базовая модель графа

В системе граф представляется как $G = (V, E)$, где:
*   $V$ — множество узлов ($N = |V|$).
*   $E$ — множество рёбер ($M = |E|$).

Каждое ребро $(i, j)$ обладает атрибутами:
1.  **Weight ($w_{ij}$)**: сила связи (проводимость). Если вес не задан, $w_{ij} = 1$.
2.  **Confidence ($c_{ij}$)**: степень уверенности в связи (используется для фильтрации).
   Это **частота встречаемости** этой связи у разных людей. 
    *   Если `confidence = 100`, значит, эта связь была найдена у **всех** 100% обследованных пациентов.
    *   Если `confidence = 20`, значит, связь есть только у каждого пятого.
3.  **Distance ($d_{ij}$)**: «геометрическая» длина ребра, обратная весу:
    $$
    d_{ij} = \frac{1}{w_{ij}} \quad (\text{если } w_{ij} > 0, \text{ иначе } \infty)
    $$

При расчетах (Centrality, Efficiency, Ricci) используются именно дистанции $d_{ij}$. Для потоковых алгоритмов используются веса $w_{ij}$.

ОЖИДАНИЯ ОТ ПОСТУПАЮЩИХ ДАННЫХ: код писался под будапештский эталонный коннектом https://pitgroup.org/connectome/

SRC_COL = df_any.columns[0]   # 1-я колонка: откуда
DST_COL = df_any.columns[1]   # 2-я колонка: куда
CONF_COL = df_any.columns[8]  # 9-я колонка: CONFIDENCE
WEIGHT_COL = df_any.columns[9] # 10-я колонка: WEIGHT
---

## 2. Глобальные топологические метрики

### 2.1. Глобальная эффективность (Weighted Efficiency)
Показывает, насколько эффективно информация передается по сети.
В теории это среднее обратных кратчайших путей между всеми парами:
$$
E_{glob} = \frac{1}{N(N-1)} \sum_{i \neq j} \frac{1}{L_{ij}}
$$
где $L_{ij}$ — длина кратчайшего пути от $i$ к $j$ в метрике $d_{ij}$.

**Реализация:**
Из-за высокой сложности $O(N^3)$ используется стохастическая аппроксимация по $k$ случайным источникам $S \subset V$:
$$
E_{glob} \approx \frac{1}{k(N-1)} \sum_{s \in S} \sum_{t \in V \setminus \{s\}} \frac{1}{L_{st}}
$$

### 2.2. Спектральные метрики (Spectral Properties)
Используются для оценки устойчивости и скорости диффузии.

1.  **Алгебраическая связность ($\lambda_2$)**:
    Второе наименьшее собственное значение нормализованного Лапласиана $\mathcal{L}$:
    $$
    \mathcal{L} = I - D^{-1/2} A D^{-1/2}
    $$
    где $A$ — матрица смежности, $D$ — диагональная матрица степеней.
    *   $\lambda_2 \approx 0$: Граф близок к распаду на компоненты.
    *   $\tau_{relax} \approx \frac{1}{\lambda_2}$: Время релаксации диффузионного процесса.

2.  **Эпидемический порог ($\lambda_{max}$)**:
    Спектральный радиус (наибольшее собственное значение) матрицы весов $A$.
    $$
    \text{Threshold} \approx \frac{1}{\lambda_{max}}
    $$
    Чем больше $\lambda_{max}$, тем легче вирусу/информации распространиться по сети.

### 2.3. Энтропия Шеннона (Information Content)
Оценивает разнообразие структуры. Для распределения степеней $p(k)$:
$$
H_{deg} = - \sum_{k} p(k) \log p(k)
$$
Аналогично считаются $H_{weight}$ и $H_{confidence}$.

---

## 3. Робастная геометрия (Advanced Metrics)

Этот блок описывает метрики, связывающие термодинамику и геометрию сетей (файл `src/robust_geom.py`).

### 3.1. Энтропийная скорость (Entropy Rate, $H_{rw}$)
Характеризует неопределенность следующего шага случайного блуждания. Мера "навигационной сложности" сети.

Пусть $s_i = \sum_j w_{ij}$ — сила узла $i$.
Матрица переходов случайного блуждания:
$$
P_{ij} = \frac{w_{ij}}{s_i}
$$
Стационарное распределение:
$$
\pi_i = \frac{s_i}{\sum_k s_k}
$$
**Формула:**
$$
H_{rw} = - \sum_{i \in V} \pi_i \sum_{j \in V} P_{ij} \log P_{ij}
$$

### 3.2. Эволюционная энтропия (Demetrius Entropy, $H_{evo}$)
Описывает робастность сети в терминах популяционной динамики. Учитывает не только локальные веса, но и вклад узлов в глобальную связность (через вектор Перрона-Фробениуса).

1.  Находим главное собственное число $\lambda$ и собственный вектор $u$ матрицы смежности $A$: $Au = \lambda u$.
2.  Строим новую матрицу переходов (PF-Markov Chain):
    $$
    \hat{P}_{ij} = \frac{a_{ij} u_j}{\lambda u_i}
    $$
3.  Находим стационарное распределение $\hat{\pi}$ для $\hat{P}$.
4.  **Формула:**
    $$
    H_{evo} = - \sum_{i} \hat{\pi}_i \sum_{j} \hat{P}_{ij} \log \hat{P}_{ij}
    $$

### 3.3. Кривизна Оливье-Риччи (Ollivier-Ricci Curvature, $\kappa$)
Геометрическая мера связности ребра. Положительная кривизна означает наличие множества альтернативных путей (треугольников), отрицательная — древовидную структуру или "мосты".

Для ребра $(x, y)$:
1.  Определяются вероятностные меры $\mu_x$ и $\mu_y$ (распределения масс на соседях $x$ и $y$).
    $$
    \mu_x(z) = \begin{cases} w_{xz}/s_x & z \sim x \\ 0 & \text{иначе} \end{cases}
    $$
2.  Вычисляется транспортное расстояние Вассерштейна $W_1(\mu_x, \mu_y)$ — минимальная стоимость переноса распределения $\mu_x$ в $\mu_y$ по метрике графа $d$.
3.  **Формула:**
    $$
    \kappa(x, y) = 1 - \frac{W_1(\mu_x, \mu_y)}{d(x, y)}
    $$

**Хрупкость (Fragility proxy):**
$$
F_{\kappa} = \frac{1}{1 + \bar{\kappa}}
$$

---

## 4. Динамика и Потоки (Energy Flow)

Модуль симуляции (`src/metrics.py`) реализует дискретную эволюцию состояния системы во времени $t$.

### 4.1. Физическая модель (Pressure / Flow)
Аналог гидравлической или электрической цепи.

*   **Состояние ($E_i$):** Энергия (или заряд) в узле $i$.
*   **Емкость ($C_i$):** "Объем" узла (обычно $C_i = s_i$, сила узла).
*   **Давление ($P_i$):**
    $$
    P_i(t) = \frac{E_i(t)}{C_i}
    $$
*   **Поток ($F_{ij}$):** Определяется разностью давлений и проводимостью ребра:
    $$
    F_{ij}(t) = w_{ij} \cdot (P_i(t) - P_j(t)) \cdot dt
    $$
    где $dt$ — коэффициент времени (для стабильности численного решения). Фиксировано.

**Уравнение обновления:**
$$
E_i(t+1) = E_i(t) \cdot \text{damping} + \underbrace{\sum_{j \sim i} (F_{ji} - F_{ij})}_{\text{Net Flow}} + \text{Injection}_i - \text{Leak}
$$

### 4.2. Модель Случайного Блуждания (RW Diffusion)
Классическая диффузия.
$$
E(t+1) = E(t) \cdot \mathbf{P}
$$
где $\mathbf{P}$ — стохастическая матрица переходов ($P_{ij} = w_{ij}/s_i$).

---

## 5. Атаки и Перколяция (Attack Lab)

Анализ устойчивости сети к удалению узлов или рёбер.

### 5.1. Порядок удаления
Узлы сортируются по метрике $M(v)$ и удаляются порциями:
*   **Degree:** $M(v) = \deg(v)$. Удар по хабам.
*   **Betweenness:** $M(v) = BC(v)$. Удар по мостам (пересчет метрики может быть дорогим).
*   **Weak nodes:** $M(v) = -\deg(v)$. Удаление периферии.
*   **Ricci (для рёбер):** Удаление рёбер с самой отрицательной кривизной (бутылочные горлышки).

### 5.2. Фазовый переход (Phase Transition)
Отслеживается параметр порядка $P_{\infty}$ — доля узлов в гигантской компоненте связности (LCC):
$$
P_{\infty}(f) = \frac{N_{LCC}(f)}{N_{original}}
$$
где $f$ — доля удаленных узлов.

**Восприимчивость (Susceptibility):**
Показывает скорость распада сети. Пик восприимчивости указывает на критическую точку $f_c$.
$$
\chi \approx -\frac{d P_{\infty}}{df}
$$

**Классификация перехода:**
*   **Continuous (2nd order):** Плавное снижение $P_{\infty}$.
*   **Abrupt (1st order):** Внезапный обвал связности ("взрывная перколяция"). Определяется эвристически: если $\frac{\Delta P_{\infty}}{\text{Range}} > 0.35$ за один шаг.

### 5.3. Hrish-Mix (Энтропийная атака)
Специфический тип атаки, при котором топология не разрушается (число узлов и ребер постоянно), но меняется структура связей (rewiring).
*   **Mix:** Операция `double_edge_swap`, сохраняющая распределение степеней, но уничтожающая корреляции (ассортативность) и кластеризацию. Сеть стремится к конфигурационной модели (Random Graph).
Суть в том, что это атака на структуру, а не на количество связей. Что если мы перемешаем связи мозга, сохранив его 'железо' (узлы) — насколько упадет его производительность?
*   ---

---

## 6. Базисные (нулевые) модели

Для понимания того, является ли метрика графа (например, коннектома мозга) статистически значимой, система позволяет генерировать «нулевые» модели.

### 6.1. Модель Эрдёша — Реньи ($G_{n,m}$)
Создает чисто случайный граф с тем же числом узлов $N$ и рёбер $M$. 
*   **Назначение:** Проверка гипотезы о «мире тесен» (small-world) и базового уровня кластеризации.
*   **Ожидаемый коэффициент кластеризации:** $C \approx p$, где $p = \frac{2M}{N(N-1)}$.

### 6.2. Конфигурационная модель (Configuration Model)
Генерирует случайный граф с **сохранением распределения степеней** узлов исходного графа.
*   **Алгоритм:** Используется метод «сшивки» случайных полуребер (stubs) с последующим удалением петель и кратных ребер.
*   **Назначение:** Определение того, вызваны ли свойства графа (например, время релаксации $\lambda_2$) специфической структурой связей или просто наличием «хабов».

### 6.3. Rewire (Double Edge Swap)
Постепенная хаотизация сети через случайные перестановки ребер. Сохраняет степени узлов, но разрушает корреляции (ассортативность) и сообщества.

---

## 7. Структурная сегментация

### 7.1. Алгоритм Лувена (Louvain Communities)
Используется для поиска иерархической структуры сообществ через максимизацию модулярности $Q$:
$$Q = \frac{1}{2M} \sum_{ij} \left[ w_{ij} - \frac{k_i k_j}{2M} \right] \delta(c_i, c_j)$$
где $k_i, k_j$ — суммы весов ребер узлов, $\delta$ — дельта-функция Кронекера (равна 1, если узлы в одном сообществе).
*   **Смысл:** Высокое $Q$ означает наличие плотных групп узлов, которые слабо связаны с остальной сетью.

---

## 8. Математика визуализации и рендеринга

Чтобы решить проблему «экспоненциальной невидимости» (когда хабы светятся, а остальное — черное), в системе применены нелинейные преобразования.

### 8.1. Логарифмическое сжатие (Log Scaling)
Перед нормализацией значения энергии $E_i$ сжимаются:
$$\tilde{E}_i = \ln(1 + E_i)$$
Это позволяет визуально уровнять разницу между узлом-источником и периферией.

### 8.2. Гамма-коррекция (Contrast)
Для усиления слабых сигналов в 3D-сцене используется степенное преобразование цвета:
$$Color_i = \left( \frac{\tilde{E}_i - \min(\tilde{E})}{\max(\tilde{E}) - \min(\tilde{E})} \right)^{1/\gamma}$$
*   При $\gamma > 1$ (в интерфейсе "Contrast"): слабые значения становятся ярче, «вытягивая» структуру потока из тени.

### 8.3. Квантильное отсечение (Robust Clipping)
Для защиты от выбросов (узлов с аномально высокой энергией) верхняя граница нормализации $V_{max}$ устанавливается по $q$-квантилю (например, 98%):
$$V_{max} = \text{percentile}(\tilde{E}, 100 - \text{clip})$$

---

## 9. Вычислительная оптимизация

### 9.1. Кэширование состояний
Используется многоуровневое кэширование (Streamlit `@st.cache_data` и `@st.cache_resource`):
1.  **Graph Cache:** Хранит объект NetworkX, пересобирается только при изменении фильтров `Min Confidence/Weight`.
2.  **Layout Cache:** Хранит 3D-координаты. Поскольку `spring_layout` итеративен, кэш экономит до 5-10 секунд при каждом переключении вкладок.
3.  **Metrics Cache:** Тяжелые метрики ($\lambda_2$, Efficiency) вычисляются в фоне.

### 9.2. Параллелизм (Parallel Ricci)
Расчет кривизны Оливье-Риччи распараллелен через `joblib`. Поскольку расчет для каждого ребра — это независимая задача линейного программирования (EMD), ускорение прямо пропорционально числу ядер CPU.

---

## 10. Интерпретация результатов (Guide)

| Наблюдение | Возможная интерпретация |
| :--- | :--- |
| **Высокая $H_{rw}$ и низкая $\bar{\kappa}$** | Сеть очень хрупкая, много «узких мест», разрушение которых изолирует части системы. |
| **Рост Modularity при атаке** | Сеть распадается на изолированные «острова» (кластеры). |
| **Длинная «полка» LCC fraction** | Высокая робастность: сеть сохраняет связность даже при потере большого числа узлов. |
| **Отрицательная кривизна $\kappa$ на магистралях** | Эти ребра являются критическими «мостами» в мозге, через них идет основной транзит трафика. |
| **Быстрое затухание энергии в `phys` моделе** | Высокая утечка (Leak) или низкая связность — сигнал не доходит до удаленных зон. |



Рекомендуется размер графа до 1500-2000 узлов. Расчёт может занимать минуты. Кое-где порядок сложности доходит до O(N^3).
Streamlit (UI), NetworkX (Graph Engine), Plotly (Visuals) и Joblib (Parallelism).

# Ссылки
https://arxiv.org/abs/1502.04512
https://www.sciencedirect.com/science/article/pii/S0378437104008288
https://arxiv.org/abs/0903.0340
https://arxiv.org/abs/math/0605212
